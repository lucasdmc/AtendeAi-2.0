# =====================================================
# CONFIGURAÇÃO HAPROXY - ENTREGÁVEL 1
# ATENDEAI 2.0
# =====================================================

global
    daemon
    maxconn 4096
    log stdout format raw local0 info
    user haproxy
    group haproxy

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close
    timeout connect 5000
    timeout client 50000
    timeout server 50000

# =====================================================
# FRONTEND - ENTRADA PRINCIPAL
# =====================================================
frontend main_frontend
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/atendeai.pem
    
    # Redirecionar HTTP para HTTPS
    redirect scheme https if !{ ssl_fc }
    
    # Headers de segurança
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Forwarded-Port %[dst_port]
    
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
    
    # ACLs para roteamento
    acl is_api path_beg /api
    acl is_health path /health
    acl is_metrics path /metrics
    acl is_admin path_beg /admin
    
    # Roteamento baseado em path
    use_backend api_gateway if is_api
    use_backend health_service if is_health
    use_backend metrics_service if is_metrics
    use_backend admin_service if is_admin
    
    # Default: frontend
    default_backend frontend_service

# =====================================================
# BACKEND - FRONTEND SERVICE
# =====================================================
backend frontend_service
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server frontend1 localhost:3000 check inter 5s rise 2 fall 3

# =====================================================
# BACKEND - API GATEWAY (KONG)
# =====================================================
backend api_gateway
    balance roundrobin
    option httpchk GET /status
    http-check expect status 200
    server kong1 kong:8000 check inter 5s rise 2 fall 3
    server kong2 kong:8000 check inter 5s rise 2 fall 3

# =====================================================
# BACKEND - HEALTH SERVICE
# =====================================================
backend health_service
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server health1 health-service:3004 check inter 5s rise 2 fall 3

# =====================================================
# BACKEND - METRICS SERVICE
# =====================================================
backend metrics_service
    balance roundrobin
    option httpchk GET /-/healthy
    http-check expect status 200
    server prometheus1 prometheus:9090 check inter 5s rise 2 fall 3

# =====================================================
# BACKEND - ADMIN SERVICE
# =====================================================
backend admin_service
    balance roundrobin
    option httpchk GET /status
    http-check expect status 200
    server kong_admin1 kong:8001 check inter 5s rise 2 fall 3
    server kong_admin2 kong:8002 check inter 5s rise 2 fall 3

# =====================================================
# BACKEND - GRAFANA
# =====================================================
backend grafana_service
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    server grafana1 grafana:3000 check inter 5s rise 2 fall 3

# =====================================================
# BACKEND - AUTH SERVICE
# =====================================================
backend auth_service
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server auth1 auth-service:3001 check inter 5s rise 2 fall 3

# =====================================================
# BACKEND - CLINIC SERVICE
# =====================================================
backend clinic_service
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server clinic1 clinic-service:3003 check inter 5s rise 2 fall 3

# =====================================================
# BACKEND - USER SERVICE
# =====================================================
backend user_service
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server user1 user-service:3002 check inter 5s rise 2 fall 3

# =====================================================
# BACKEND - CONVERSATION SERVICE
# =====================================================
backend conversation_service
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server conversation1 conversation-service:3005 check inter 5s rise 2 fall 3

# =====================================================
# BACKEND - APPOINTMENT SERVICE
# =====================================================
backend appointment_service
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server appointment1 appointment-service:3006 check inter 5s rise 2 fall 3

# =====================================================
# BACKEND - WHATSAPP SERVICE
# =====================================================
backend whatsapp_service
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server whatsapp1 whatsapp-service:3007 check inter 5s rise 2 fall 3

# =====================================================
# BACKEND - GOOGLE CALENDAR SERVICE
# =====================================================
backend google_calendar_service
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server google_calendar1 google-calendar-service:3008 check inter 5s rise 2 fall 3

# =====================================================
# STATS - MONITORAMENTO DO HAPROXY
# =====================================================
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
    stats auth admin:admin123
